@page "/"
@using KannadaNudiWeb.Services
@inject TransliterationService TransliterationService
@inject SpeechService SpeechService
@inject IJSRuntime JSRuntime

<PageTitle>Kannada Nudi Editor</PageTitle>

<div class="app-layout">
    <!-- Header Section: Contains Custom App Bar AND Quill Toolbar -->
    <div class="header-section">
        <!-- Top Row: Branding and App Controls -->
        <div class="app-toolbar">
            <div class="toolbar-start">
                <div class="brand-badge">
                    <span class="bi bi-file-earmark-richtext-fill"></span>
                    <span class="brand-text">NudiWeb Editor</span>
                </div>
            </div>

            <div class="toolbar-center">
                <div class="control-group">
                    <div class="input-mode-toggle">
                        <span class="toggle-label @(!IsKannadaInput ? "active" : "")">ENG</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="inputModeSwitch" checked="@IsKannadaInput" @onchange="OnInputModeChange">
                        </div>
                        <span class="toggle-label @(IsKannadaInput ? "active" : "")">KAN</span>
                    </div>

                    @if (IsKannadaInput)
                    {
                        <select class="layout-select" @onchange="OnLayoutChange">
                            <option value="Nudi">Nudi</option>
                            <option value="Baraha">Baraha</option>
                        </select>
                    }
                </div>
            </div>

            <div class="toolbar-end">
                <div class="action-buttons">
                    <button class="btn-icon-text @(isListening ? "listening" : "")" @onclick="ToggleSpeech">
                        <span class="bi bi-mic@(isListening ? "-fill" : "")"></span>
                        <span class="btn-label">@(isListening ? "Stop" : "Dictate")</span>
                    </button>

                    <div class="separator"></div>

                    <button class="btn-icon" @onclick="SaveDocument" title="Save">
                        <span class="bi bi-save"></span>
                    </button>
                    <button class="btn-icon" @onclick="OpenPageSetup" title="Page Setup">
                        <span class="bi bi-gear"></span>
                    </button>

                     <InputFile OnChange="LoadDocument" class="file-input-hidden" id="fileUpload" />
                     <label for="fileUpload" class="btn-icon" title="Open">
                         <span class="bi bi-folder2-open"></span>
                     </label>
                </div>
            </div>
        </div>

        <!-- Bottom Row: The Ribbon (Quill Toolbar) -->
        <!-- We explicitly define the toolbar structure here so it lives in the header -->
        <div id="quill-toolbar-container">
            <span class="ql-formats">
                <select class="ql-font">
                    <option selected>Sans Serif</option>
                    <option value="nudiparijatha">Nudi Parijatha</option>
                    <option value="nudi-01-e">Nudi 01 E</option>
                    <option value="nudi-01-k">Nudi 01 K</option>
                    <option value="nudi-02-e">Nudi 02 E</option>
                    <option value="nudi-05-e">Nudi 05 E</option>
                    <option value="nudi-10-e">Nudi 10 E</option>
                </select>
                <select class="ql-size"></select>
            </span>
            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
            </span>
            <span class="ql-formats">
                <button class="ql-script" value="sub"></button>
                <button class="ql-script" value="super"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-header" value="1"></button>
                <button class="ql-header" value="2"></button>
                <button class="ql-blockquote"></button>
                <button class="ql-code-block"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
                <button class="ql-indent" value="-1"></button>
                <button class="ql-indent" value="+1"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-direction" value="rtl"></button>
                <select class="ql-align"></select>
            </span>
            <span class="ql-formats">
                <button class="ql-link"></button>
                <button class="ql-image"></button>
                <button class="ql-video"></button>
                <button class="ql-formula"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-clean"></button>
            </span>
        </div>
    </div>

    <!-- Main Workspace (Scrollable) -->
    <div id="editor-workspace">
        <!-- The Page Container -->
        <div id="quill-editor" style="@CurrentPageStyle"></div>
    </div>
</div>

<!-- Modals (Save & Page Setup) -->
@if (showSaveModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-card">
                <div class="modal-header-clean">
                    <h5>Save Document</h5>
                    <button type="button" class="btn-close-clean" @onclick="CloseModal"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="modal-body p-4">
                    <label class="input-label">Filename</label>
                    <input type="text" class="input-clean mb-4" @bind="saveFileName" placeholder="Untitled Document">
                    <div class="action-grid">
                        <button class="btn-action primary" @onclick="DownloadDocx">
                            <i class="bi bi-file-word"></i> Word (.docx)
                        </button>
                        <button class="btn-action secondary" @onclick="DownloadTxt">
                            <i class="bi bi-file-text"></i> Text (.txt)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (showPageSetupModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-card">
                 <div class="modal-header-clean">
                    <h5>Page Setup</h5>
                    <button type="button" class="btn-close-clean" @onclick="ClosePageSetup"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="input-label">Size</label>
                        <select class="input-clean" @bind="pageSettings.PageSize">
                            <option value="A4">A4 (210mm x 297mm)</option>
                            <option value="Letter">Letter (215.9mm x 279.4mm)</option>
                        </select>
                    </div>
                    <label class="input-label mb-2">Margins (mm)</label>
                    <div class="margin-grid">
                        <div class="margin-input">
                            <span>Top</span>
                            <input type="number" class="input-clean" @bind="pageSettings.MarginTop" />
                        </div>
                         <div class="margin-input">
                            <span>Bottom</span>
                            <input type="number" class="input-clean" @bind="pageSettings.MarginBottom" />
                        </div>
                         <div class="margin-input">
                            <span>Left</span>
                            <input type="number" class="input-clean" @bind="pageSettings.MarginLeft" />
                        </div>
                         <div class="margin-input">
                            <span>Right</span>
                            <input type="number" class="input-clean" @bind="pageSettings.MarginRight" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer-clean">
                     <button class="btn-text" @onclick="ClosePageSetup">Cancel</button>
                     <button class="btn-action primary small" @onclick="ApplyPageSetup">Apply</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Reset & Fonts */
    :root {
        --app-bg: #f3f2f1;
        --header-bg: #ffffff;
        --border-color: #e1dfdd;
        --primary: #0078d4;
        --text-color: #323130;
    }

    body {
        margin: 0;
        padding: 0;
        background-color: var(--app-bg);
        font-family: 'Segoe UI', 'Poppins', sans-serif;
        color: var(--text-color);
        overflow: hidden; /* Prevent body scroll */
    }

    /* Layout */
    .app-layout {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
    }

    .header-section {
        flex: 0 0 auto;
        background-color: var(--header-bg);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        z-index: 100;
        display: flex;
        flex-direction: column;
    }

    /* App Toolbar (Top Row) */
    .app-toolbar {
        height: 48px;
        background-color: #2b579a; /* Word-ish Blue Header */
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
    }

    .brand-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 1rem;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 16px;
        background: rgba(255,255,255,0.1);
        padding: 4px 12px;
        border-radius: 4px;
    }

    .input-mode-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .toggle-label { opacity: 0.6; }
    .toggle-label.active { opacity: 1; color: #fff; }

    .layout-select {
        background: transparent;
        border: none;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
    }
    .layout-select option { color: #333; }

    .toolbar-end .action-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-icon, .btn-icon-text {
        background: transparent;
        border: none;
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 3px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-icon:hover, .btn-icon-text:hover {
        background: rgba(255,255,255,0.2);
    }
    .btn-icon-text.listening {
        background: #d13438;
    }
    .separator {
        width: 1px;
        height: 20px;
        background: rgba(255,255,255,0.3);
        margin: 0 4px;
    }

    /* Ribbon (Quill Toolbar) */
    #quill-toolbar-container {
        border-bottom: 1px solid var(--border-color);
        background: #f3f2f1;
        padding: 8px 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    /* Workspace */
    #editor-workspace {
        flex: 1 1 auto;
        overflow-y: auto;
        background-color: #e3e3e3; /* Gray Desk */
        padding: 40px 0;
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Important for growing page */
    }

    /* The Page */
    .ql-editor {
        background-color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);

        /* Layout Variables */
        width: var(--page-width, 210mm);
        min-height: var(--page-height, 297mm);
        padding: var(--page-margin-top, 25mm) var(--page-margin-right, 25mm) var(--page-margin-bottom, 25mm) var(--page-margin-left, 25mm) !important;

        overflow-y: visible !important;
        color: black;

        /* The Gap Trick */
        /* Gradient: White for page height, then Gray for gap */
        /* We need to know the gap size. Let's say 10mm gap */
        --gap-size: 10mm;
        --total-height: calc(var(--page-height) + var(--gap-size));

        background-image: repeating-linear-gradient(
            to bottom,
            white 0px,
            white var(--page-height),
            #e3e3e3 var(--page-height),
            #e3e3e3 var(--total-height)
        );
        background-size: 100% var(--total-height);

        /* To make the text not flow into the gap, we rely on the user manually respecting pages
           OR we accept this is a visual approximation.
           Since actual pagination is hard, we just keep the visual look. */
    }

    .ql-container.ql-snow {
        border: none !important;
    }

    /* Modals */
    .modern-card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .modal-header-clean {
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f0f0f0;
    }
    .modal-header-clean h5 { margin: 0; font-weight: 600; font-size: 1.1rem; }
    .btn-close-clean { background: none; border: none; font-size: 1.2rem; color: #999; }

    .input-label { font-size: 0.85rem; font-weight: 600; color: #666; margin-bottom: 6px; display: block; }
    .input-clean {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f9f9f9;
        font-size: 0.95rem;
    }
    .input-clean:focus { outline: none; border-color: var(--primary); background: white; }

    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn-action {
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.1s;
    }
    .btn-action.primary { background: var(--primary); color: white; }
    .btn-action.secondary { background: #f0f0f0; color: #333; }
    .btn-action:active { transform: scale(0.98); }
    .btn-action.small { padding: 8px 24px; }

    .margin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .margin-input { display: flex; flex-direction: column; gap: 4px; }
    .margin-input span { font-size: 0.75rem; color: #888; text-transform: uppercase; }
    .modal-footer-clean { padding: 16px 20px; background: #f9f9f9; display: flex; justify-content: flex-end; gap: 12px; }
    .btn-text { background: none; border: none; color: #666; font-weight: 600; }

    .file-input-hidden { display: none; }
    .modal-backdrop { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }

    @@media print {
        .header-section, .modal, .modal-backdrop { display: none !important; }
        body, .app-layout, #editor-workspace {
            height: auto; overflow: visible; background: white; display: block;
        }
        #editor-workspace { padding: 0; }
        .ql-editor {
            box-shadow: none;
            width: 100%;
            margin: 0;
            background: none !important; /* No gaps in print, let browser handle it */
        }
        @@page { size: var(--page-width) var(--page-height); margin: 0; }
    }
</style>

@code {
    public bool IsKannadaInput { get; set; } = false;

    bool isListening = false;
    bool showSaveModal = false;
    bool showPageSetupModal = false;
    string saveFileName = "Document";
    string speechLang = "kn-IN";
    DotNetObjectReference<Home>? objRef;

    class PageSettingsModel
    {
        public string PageSize { get; set; } = "A4";
        public int MarginTop { get; set; } = 25;
        public int MarginBottom { get; set; } = 25;
        public int MarginLeft { get; set; } = 25;
        public int MarginRight { get; set; } = 25;
    }

    PageSettingsModel pageSettings = new PageSettingsModel();
    string CurrentPageStyle = "";

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        UpdatePageStyle(); // Initialize styles
        await TransliterationService.InitializeAsync();
        SpeechService.OnResult += OnSpeechResult;
        SpeechService.OnError += OnSpeechError;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Note: We now pass the ID of the container, not the selector
            await JSRuntime.InvokeVoidAsync("quillInterop.init", "#quill-editor", objRef);
            await JSRuntime.InvokeVoidAsync("quillInterop.registerKeyInterceptor", objRef);
        }
    }

    private void UpdatePageStyle()
    {
        string width = pageSettings.PageSize == "A4" ? "210mm" : "215.9mm";
        string height = pageSettings.PageSize == "A4" ? "297mm" : "279.4mm";

        CurrentPageStyle = $"--page-width: {width}; --page-height: {height}; " +
                           $"--page-margin-top: {pageSettings.MarginTop}mm; " +
                           $"--page-margin-bottom: {pageSettings.MarginBottom}mm; " +
                           $"--page-margin-left: {pageSettings.MarginLeft}mm; " +
                           $"--page-margin-right: {pageSettings.MarginRight}mm;";
    }

    private void OpenPageSetup()
    {
        showPageSetupModal = true;
    }

    private void ClosePageSetup()
    {
        showPageSetupModal = false;
    }

    private void ApplyPageSetup()
    {
        UpdatePageStyle();
        ClosePageSetup();
    }

    private async Task OnInputModeChange(ChangeEventArgs args)
    {
        IsKannadaInput = (bool)(args.Value ?? false);
        if (!IsKannadaInput)
        {
            TransliterationService.ClearBuffer();
        }
        await JSRuntime.InvokeVoidAsync("quillInterop.setKannadaMode", IsKannadaInput);
    }

    private void OnLayoutChange(ChangeEventArgs args)
    {
        if (args.Value != null && Enum.TryParse<KeyboardLayout>(args.Value.ToString(), out var layout))
        {
            TransliterationService.SetLayout(layout);
        }
    }

    [JSInvokable]
    public void OnSelectionChanged()
    {
        TransliterationService.ClearBuffer();
    }

    [JSInvokable]
    public void ProcessBackspace()
    {
        TransliterationService.RemoveLast();
    }

    [JSInvokable]
    public async Task ProcessKannadaKey(string key)
    {
        var result = TransliterationService.GetTransliteration(key);

        if (result.backspaceCount > 0)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.backspace", result.backspaceCount);
        }

        if (!string.IsNullOrEmpty(result.text))
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", result.text);
        }
    }

    private async void ToggleSpeech()
    {
        if (isListening)
        {
            await SpeechService.StopAsync();
            isListening = false;
        }
        else
        {
            await SpeechService.StartAsync(speechLang);
            isListening = true;
        }
    }

    private void OnSpeechResult(string text)
    {
        InvokeAsync(async () =>
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", text + " ");
        });
    }

    private void OnSpeechError(string error)
    {
        Console.WriteLine($"Speech Error: {error}");
        isListening = false;
        StateHasChanged();
    }

    private void SaveDocument()
    {
        showSaveModal = true;
    }

    private void CloseModal()
    {
        showSaveModal = false;
    }

    private async Task DownloadDocx()
    {
        string html = await JSRuntime.InvokeAsync<string>("quillInterop.getHtml");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.docx" : $"{saveFileName}.docx";
        await JSRuntime.InvokeVoidAsync("quillInterop.saveAsDocx", filename, html);
        CloseModal();
    }

    private async Task DownloadTxt()
    {
        string text = await JSRuntime.InvokeAsync<string>("quillInterop.getText");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.txt" : $"{saveFileName}.txt";
        await JSRuntime.InvokeVoidAsync("quillInterop.downloadFile", filename, text, "text/plain");
        CloseModal();
    }

    private async Task LoadDocument(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            string content = await reader.ReadToEndAsync();

            await JSRuntime.InvokeVoidAsync("quillInterop.setHtml", content);
        }
        catch(Exception ex)
        {
            Console.WriteLine("Error loading file: " + ex.Message);
        }
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
