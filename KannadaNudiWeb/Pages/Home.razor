@page "/"
@using KannadaNudiWeb.Services
@inject TransliterationService TransliterationService
@inject SpeechService SpeechService
@inject IJSRuntime JSRuntime

<PageTitle>Kannada Nudi Editor</PageTitle>

<div class="toolbar-container">
    <div class="toolbar-group">
        <label class="toolbar-label">Input Mode:</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="inputModeSwitch" checked="@IsKannadaInput" @onchange="OnInputModeChange">
            <label class="form-check-label" for="inputModeSwitch">@(IsKannadaInput ? "KAN" : "ENG")</label>
        </div>
    </div>

    <div class="toolbar-group">
         <button class="btn @(isListening ? "btn-danger" : "btn-primary")" @onclick="ToggleSpeech" disabled="@isModelLoading">
             @if (isModelLoading)
             {
                 <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                 <span> @(isStarting ? "Starting..." : "Loading Model...")</span>
             }
             else
             {
                 <span class="bi bi-mic"></span> @(isListening ? "Stop Speech" : "Start Speech")
             }
         </button>
         <select class="form-select ms-2" style="width:auto; display:inline-block;" @bind="speechLang" disabled="@isListening">
             <option value="kn-IN">Kannada</option>
             <option value="en-IN">English</option>
         </select>
    </div>

    <div class="toolbar-group">
         <button class="btn btn-secondary" @onclick="SaveDocument">
             <span class="bi bi-save"></span> Save
         </button>
         <InputFile OnChange="LoadDocument" class="file-input-hidden" id="fileUpload" />
         <label for="fileUpload" class="btn btn-secondary"><span class="bi bi-folder2-open"></span> Open</label>
    </div>
</div>

<div id="editor-wrapper" tabindex="0" style="outline:none;">
    <div id="quill-editor" style="height: 600px;"></div>
</div>

@if (showSaveModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show" style="display:block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Document</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filenameInput" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="filenameInput" @bind="saveFileName">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="DownloadDocx">Download as DocX</button>
                        <button class="btn btn-secondary" @onclick="DownloadTxt">Download as TXT</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Removed <script> block, logic moved to quillInterop.js -->

<style>
    .toolbar-container {
        display: flex;
        gap: 20px;
        padding: 10px;
        background: #f3f3f3;
        border-bottom: 1px solid #ccc;
        align-items: center;
    }
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .file-input-hidden {
        display: none;
    }
    .modal-backdrop {
        background-color: rgba(0,0,0,0.5);
    }
</style>

@code {
    public bool IsKannadaInput { get; set; } = false;

    bool isListening = false;
    bool isModelLoading = false;
    bool isStarting = false;
    bool showSaveModal = false;
    string saveFileName = "Document";
    string speechLang = "kn-IN";
    DotNetObjectReference<Home>? objRef;

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        await TransliterationService.InitializeAsync();
        SpeechService.OnResult += OnSpeechResult;
        SpeechService.OnError += OnSpeechError;
        SpeechService.OnStatus += OnSpeechStatus;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.init", "#quill-editor", objRef);
            // Updated call to use namespaced function
            await JSRuntime.InvokeVoidAsync("quillInterop.registerKeyInterceptor", objRef);
        }
    }

    private async Task OnInputModeChange(ChangeEventArgs args)
    {
        IsKannadaInput = (bool)(args.Value ?? false);
        if (!IsKannadaInput)
        {
            TransliterationService.ClearBuffer();
        }
        await JSRuntime.InvokeVoidAsync("quillInterop.setKannadaMode", IsKannadaInput);
    }

    [JSInvokable]
    public void OnSelectionChanged()
    {
        TransliterationService.ClearBuffer();
    }

    [JSInvokable]
    public void ProcessBackspace()
    {
        TransliterationService.RemoveLast();
    }

    [JSInvokable]
    public async Task ProcessKannadaKey(string key)
    {
        var result = TransliterationService.GetTransliteration(key);

        if (result.backspaceCount > 0)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.backspace", result.backspaceCount);
        }

        if (!string.IsNullOrEmpty(result.text))
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", result.text);
        }
    }

    private async void ToggleSpeech()
    {
        if (isListening)
        {
            await SpeechService.StopAsync();
            isListening = false;
        }
        else
        {
            await SpeechService.StartAsync(speechLang);
            // State update will happen via OnSpeechStatus
        }
    }

    private void OnSpeechStatus(string status)
    {
        InvokeAsync(() =>
        {
            if (status == "loading")
            {
                isModelLoading = true;
                isStarting = false;
                isListening = false;
            }
            else if (status == "starting")
            {
                isModelLoading = true;
                isStarting = true;
                isListening = false;
            }
            else if (status == "ready")
            {
                isModelLoading = false;
                isStarting = false;
                isListening = false;
            }
            else if (status == "listening")
            {
                isModelLoading = false;
                isStarting = false;
                isListening = true;
            }
            StateHasChanged();
        });
    }

    private void OnSpeechResult(string text)
    {
        InvokeAsync(async () =>
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", text + " ");
        });
    }

    private void OnSpeechError(string error)
    {
        Console.WriteLine($"Speech Error: {error}");
        InvokeAsync(() =>
        {
            isListening = false;
            isModelLoading = false;
            isStarting = false;
            StateHasChanged();
        });
    }

    private void SaveDocument()
    {
        showSaveModal = true;
    }

    private void CloseModal()
    {
        showSaveModal = false;
    }

    private async Task DownloadDocx()
    {
        string html = await JSRuntime.InvokeAsync<string>("quillInterop.getHtml");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.docx" : $"{saveFileName}.docx";
        await JSRuntime.InvokeVoidAsync("quillInterop.saveAsDocx", filename, html);
        CloseModal();
    }

    private async Task DownloadTxt()
    {
        string text = await JSRuntime.InvokeAsync<string>("quillInterop.getText");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.txt" : $"{saveFileName}.txt";
        await JSRuntime.InvokeVoidAsync("quillInterop.downloadFile", filename, text, "text/plain");
        CloseModal();
    }

    private async Task LoadDocument(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            string content = await reader.ReadToEndAsync();

            await JSRuntime.InvokeVoidAsync("quillInterop.setHtml", content);
        }
        catch(Exception ex)
        {
            Console.WriteLine("Error loading file: " + ex.Message);
        }
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
