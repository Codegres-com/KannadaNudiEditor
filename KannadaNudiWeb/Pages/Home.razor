@page "/"
@using KannadaNudiWeb.Services
@inject TransliterationService TransliterationService
@inject SpeechService SpeechService
@inject IJSRuntime JSRuntime

<PageTitle>Kannada Nudi Editor</PageTitle>

<div class="app-layout">
    <!-- Sticky Header containing Custom Toolbar and Quill Toolbar -->
    <div class="sticky-header">
        <div class="toolbar-container">
            <div class="toolbar-section left">
                <div class="brand-logo">
                    <!-- Placeholder for branding if needed, or just grouping -->
                    <span class="bi bi-keyboard-fill me-2"></span> NudiWeb
                </div>
            </div>

            <div class="toolbar-section center">
                 <!-- Input Mode Switch -->
                <div class="tool-item">
                    <div class="form-check form-switch custom-switch">
                        <input class="form-check-input" type="checkbox" id="inputModeSwitch" checked="@IsKannadaInput" @onchange="OnInputModeChange">
                        <label class="form-check-label" for="inputModeSwitch">@(IsKannadaInput ? "KAN" : "ENG")</label>
                    </div>
                </div>

                @if (IsKannadaInput)
                {
                    <div class="tool-item">
                        <select class="form-select form-select-sm modern-select" @onchange="OnLayoutChange">
                            <option value="Nudi">Nudi/KGP</option>
                            <option value="Baraha">Baraha (Phonetic)</option>
                        </select>
                    </div>
                }

                <!-- Speech Controls -->
                 <div class="tool-item">
                     <button class="btn btn-sm btn-modern @(isListening ? "btn-danger-soft" : "btn-primary-soft")" @onclick="ToggleSpeech" title="@(isListening ? "Stop Speech" : "Start Speech")">
                         <span class="bi bi-mic@(isListening ? "-fill" : "")"></span>
                     </button>
                     <select class="form-select form-select-sm modern-select ms-1" style="width:auto; display:inline-block;" @bind="speechLang">
                         <option value="kn-IN">Kannada</option>
                         <option value="en-IN">English</option>
                     </select>
                </div>
            </div>

            <div class="toolbar-section right">
                 <!-- File Actions -->
                 <div class="action-group">
                     <InputFile OnChange="LoadDocument" class="file-input-hidden" id="fileUpload" />
                     <label for="fileUpload" class="btn btn-sm btn-modern btn-icon" title="Open Document">
                         <span class="bi bi-folder2-open"></span>
                     </label>

                     <button class="btn btn-sm btn-modern btn-icon" @onclick="SaveDocument" title="Save Document">
                         <span class="bi bi-save"></span>
                     </button>

                     <button class="btn btn-sm btn-modern btn-icon" @onclick="OpenPageSetup" title="Page Setup">
                         <span class="bi bi-gear"></span>
                     </button>
                 </div>
            </div>
        </div>

        <!-- Target Container for Quill Toolbar -->
        <div id="quill-toolbar-target"></div>
    </div>

    <!-- Scrollable Editor Desk -->
    <div id="editor-wrapper" tabindex="0" style="outline:none;">
        <div id="quill-editor" style="@CurrentPageStyle"></div>
    </div>
</div>

<!-- Modern Save Modal -->
@if (showSaveModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold"><span class="bi bi-save me-2"></span>Save Document</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="mb-4">
                        <label for="filenameInput" class="form-label text-muted small fw-bold text-uppercase">Filename</label>
                        <input type="text" class="form-control form-control-modern" id="filenameInput" @bind="saveFileName" placeholder="Enter document name...">
                    </div>
                    <div class="d-grid gap-3">
                        <button class="btn btn-modern-primary py-2" @onclick="DownloadDocx">
                            <span class="bi bi-file-earmark-word me-2"></span>Download as DocX
                        </button>
                        <button class="btn btn-modern-secondary py-2" @onclick="DownloadTxt">
                            <span class="bi bi-file-text me-2"></span>Download as TXT
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modern Page Setup Modal -->
@if (showPageSetupModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold"><span class="bi bi-layout-text-window-reverse me-2"></span>Page Setup</h5>
                    <button type="button" class="btn-close" @onclick="ClosePageSetup"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold text-uppercase">Paper Size</label>
                        <select class="form-select form-select-modern" @bind="pageSettings.PageSize">
                            <option value="A4">A4 (210mm x 297mm)</option>
                            <option value="Letter">Letter (215.9mm x 279.4mm)</option>
                        </select>
                    </div>

                    <label class="form-label text-muted small fw-bold text-uppercase mb-3">Margins (mm)</label>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-floating-modern">
                                <label>Top</label>
                                <input type="number" class="form-control form-control-modern" @bind="pageSettings.MarginTop" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating-modern">
                                <label>Bottom</label>
                                <input type="number" class="form-control form-control-modern" @bind="pageSettings.MarginBottom" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating-modern">
                                <label>Left</label>
                                <input type="number" class="form-control form-control-modern" @bind="pageSettings.MarginLeft" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating-modern">
                                <label>Right</label>
                                <input type="number" class="form-control form-control-modern" @bind="pageSettings.MarginRight" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-sm btn-modern-text text-secondary" @onclick="ClosePageSetup">Cancel</button>
                    <button type="button" class="btn btn-sm btn-modern-primary px-4" @onclick="ApplyPageSetup">Apply Changes</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Layout Structure */
    .app-layout {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        background-color: #555; /* Desk Background */
    }

    .sticky-header {
        flex-shrink: 0;
        z-index: 2000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        background: #fff;
    }

    /* Custom Toolbar Styling */
    .toolbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
    }

    .toolbar-section {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .brand-logo {
        font-weight: 700;
        color: #333;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }

    .tool-item {
        display: flex;
        align-items: center;
    }

    .action-group {
        display: flex;
        gap: 8px;
        background: #f8f9fa;
        padding: 4px;
        border-radius: 8px;
    }

    /* Modern Controls */
    .btn-modern {
        border: none;
        background: transparent;
        color: #555;
        border-radius: 6px;
        transition: all 0.2s;
        padding: 6px 10px;
    }
    .btn-modern:hover {
        background: #e9ecef;
        color: #000;
        transform: translateY(-1px);
    }
    .btn-icon {
        padding: 6px 10px;
        font-size: 1.1rem;
    }

    .btn-modern-primary {
        background: #1b6ec2;
        color: white;
        border: none;
        border-radius: 8px;
        transition: 0.2s;
    }
    .btn-modern-primary:hover {
        background: #155595;
    }

    .btn-modern-secondary {
        background: #e9ecef;
        color: #333;
        border: none;
        border-radius: 8px;
    }

    .btn-danger-soft {
        background: #fee2e2;
        color: #dc2626;
    }
    .btn-primary-soft {
        background: #e0f2fe;
        color: #0284c7;
    }

    .modern-select {
        border: 1px solid #eee;
        border-radius: 6px;
        font-size: 0.9rem;
        background-color: #f8f9fa;
    }

    /* Quill Toolbar Target */
    #quill-toolbar-target {
        background: #fff;
        border-bottom: 1px solid #eee;
    }
    /* Override Quill Toolbar Styles for integration */
    .ql-toolbar.ql-snow {
        border: none !important;
        padding: 8px 16px !important;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    /* Editor Desk */
    #editor-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 40px 20px;
        align-items: center;
    }

    #quill-editor {
        display: flex;
        flex-direction: column;
    }

    /* The Paper */
    .ql-editor {
        background-color: white;
        box-shadow: 0 4px 30px rgba(0,0,0,0.15);

        /* Dimensions from CSS Variables */
        width: var(--page-width, 210mm);
        min-height: var(--page-height, 297mm);
        padding: var(--page-margin-top, 25mm) var(--page-margin-right, 25mm) var(--page-margin-bottom, 25mm) var(--page-margin-left, 25mm) !important;

        overflow-y: visible !important;

        /* Visual Page Breaks */
        background-image: linear-gradient(to bottom, transparent calc(var(--page-height) - 1px), #ccc calc(var(--page-height) - 1px), #ccc var(--page-height));
        background-size: 100% var(--page-height);
        background-repeat: repeat-y;

        margin-bottom: 20px;
    }
    .ql-editor > * {
        max-width: 100%;
    }

    /* Modern Modal Styling */
    .modern-modal {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        backdrop-filter: blur(10px); /* Glass effect attempt */
    }

    .form-control-modern, .form-select-modern {
        background-color: #f5f7fa;
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 10px 15px;
        transition: 0.2s;
    }
    .form-control-modern:focus, .form-select-modern:focus {
        background-color: #fff;
        border-color: #1b6ec2;
        box-shadow: 0 0 0 4px rgba(27, 110, 194, 0.1);
    }

    .form-floating-modern label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        color: #6c757d;
        margin-bottom: 4px;
        text-transform: uppercase;
    }

    .file-input-hidden {
        display: none;
    }
    .modal-backdrop {
        background-color: rgba(0,0,0,0.4);
        backdrop-filter: blur(2px);
    }

    @@media (max-width: 768px) {
        .toolbar-container {
            flex-direction: column;
            gap: 10px;
            padding: 12px;
        }
        .toolbar-section {
            width: 100%;
            justify-content: space-between;
        }
        .toolbar-section.center {
            justify-content: space-around;
        }
        #editor-wrapper {
            padding: 10px;
        }
    }

    @@media print {
        body {
            background: white;
            overflow: visible;
            height: auto;
        }
        .app-layout, .sticky-header {
            display: block;
            height: auto;
            overflow: visible;
        }
        .sticky-header, .toolbar-container, .modal-backdrop, .modal {
            display: none !important;
        }
        #editor-wrapper {
            padding: 0;
            background: white;
            overflow: visible;
            height: auto;
            display: block;
        }
        .ql-editor {
            box-shadow: none;
            margin: 0;
            width: 100%;
        }
        @@page {
            size: var(--page-width) var(--page-height);
            margin: 0;
        }
    }
</style>

@code {
    public bool IsKannadaInput { get; set; } = false;

    bool isListening = false;
    bool showSaveModal = false;
    bool showPageSetupModal = false;
    string saveFileName = "Document";
    string speechLang = "kn-IN";
    DotNetObjectReference<Home>? objRef;

    class PageSettingsModel
    {
        public string PageSize { get; set; } = "A4";
        public int MarginTop { get; set; } = 25;
        public int MarginBottom { get; set; } = 25;
        public int MarginLeft { get; set; } = 25;
        public int MarginRight { get; set; } = 25;
    }

    PageSettingsModel pageSettings = new PageSettingsModel();
    string CurrentPageStyle = "";

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        UpdatePageStyle(); // Initialize styles
        await TransliterationService.InitializeAsync();
        SpeechService.OnResult += OnSpeechResult;
        SpeechService.OnError += OnSpeechError;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.init", "#quill-editor", objRef);
            await JSRuntime.InvokeVoidAsync("quillInterop.registerKeyInterceptor", objRef);
        }
    }

    private void UpdatePageStyle()
    {
        string width = pageSettings.PageSize == "A4" ? "210mm" : "215.9mm";
        string height = pageSettings.PageSize == "A4" ? "297mm" : "279.4mm";

        CurrentPageStyle = $"--page-width: {width}; --page-height: {height}; " +
                           $"--page-margin-top: {pageSettings.MarginTop}mm; " +
                           $"--page-margin-bottom: {pageSettings.MarginBottom}mm; " +
                           $"--page-margin-left: {pageSettings.MarginLeft}mm; " +
                           $"--page-margin-right: {pageSettings.MarginRight}mm;";
    }

    private void OpenPageSetup()
    {
        showPageSetupModal = true;
    }

    private void ClosePageSetup()
    {
        showPageSetupModal = false;
    }

    private void ApplyPageSetup()
    {
        UpdatePageStyle();
        ClosePageSetup();
    }

    private async Task OnInputModeChange(ChangeEventArgs args)
    {
        IsKannadaInput = (bool)(args.Value ?? false);
        if (!IsKannadaInput)
        {
            TransliterationService.ClearBuffer();
        }
        await JSRuntime.InvokeVoidAsync("quillInterop.setKannadaMode", IsKannadaInput);
    }

    private void OnLayoutChange(ChangeEventArgs args)
    {
        if (args.Value != null && Enum.TryParse<KeyboardLayout>(args.Value.ToString(), out var layout))
        {
            TransliterationService.SetLayout(layout);
        }
    }

    [JSInvokable]
    public void OnSelectionChanged()
    {
        TransliterationService.ClearBuffer();
    }

    [JSInvokable]
    public void ProcessBackspace()
    {
        TransliterationService.RemoveLast();
    }

    [JSInvokable]
    public async Task ProcessKannadaKey(string key)
    {
        var result = TransliterationService.GetTransliteration(key);

        if (result.backspaceCount > 0)
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.backspace", result.backspaceCount);
        }

        if (!string.IsNullOrEmpty(result.text))
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", result.text);
        }
    }

    private async void ToggleSpeech()
    {
        if (isListening)
        {
            await SpeechService.StopAsync();
            isListening = false;
        }
        else
        {
            await SpeechService.StartAsync(speechLang);
            isListening = true;
        }
    }

    private void OnSpeechResult(string text)
    {
        InvokeAsync(async () =>
        {
            await JSRuntime.InvokeVoidAsync("quillInterop.insertText", text + " ");
        });
    }

    private void OnSpeechError(string error)
    {
        Console.WriteLine($"Speech Error: {error}");
        isListening = false;
        StateHasChanged();
    }

    private void SaveDocument()
    {
        showSaveModal = true;
    }

    private void CloseModal()
    {
        showSaveModal = false;
    }

    private async Task DownloadDocx()
    {
        string html = await JSRuntime.InvokeAsync<string>("quillInterop.getHtml");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.docx" : $"{saveFileName}.docx";
        await JSRuntime.InvokeVoidAsync("quillInterop.saveAsDocx", filename, html);
        CloseModal();
    }

    private async Task DownloadTxt()
    {
        string text = await JSRuntime.InvokeAsync<string>("quillInterop.getText");
        string filename = string.IsNullOrWhiteSpace(saveFileName) ? "Document.txt" : $"{saveFileName}.txt";
        await JSRuntime.InvokeVoidAsync("quillInterop.downloadFile", filename, text, "text/plain");
        CloseModal();
    }

    private async Task LoadDocument(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            string content = await reader.ReadToEndAsync();

            await JSRuntime.InvokeVoidAsync("quillInterop.setHtml", content);
        }
        catch(Exception ex)
        {
            Console.WriteLine("Error loading file: " + ex.Message);
        }
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
